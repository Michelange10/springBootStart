/*!
 * DrizzleJS v0.4.17
 * -------------------------------------
 * Copyright (c) 2017 Jaco Koo <jaco.koo@guyong.in>
 * Distributed under MIT license
 */
!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Drizzle=e()}(this,function(){"use strict";function t(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function e(t,e,n,i){var r=n.replace(g[0],g[1]).replace(g[2],g[3]);this.pattern=new RegExp("^"+r+"$",t.options.caseSensitiveHash?"g":"gi"),this.app=t,this.router=e,this.path=n,this.fn=i}var n=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;
try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(u){r=!0,o=u}finally{try{!i&&s["return"]&&s["return"]()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i={},r=i,o=[].slice,a=function(t,e){var n=[];if(!t)return n;if(t.map)return t.map(e);for(var i=0;i<t.length;i++)n.push(e(t[i],i,t));
return n},s=function(t,e){var n=[],i=void 0;if(!t)return n;for(i in t)r.hasOwnProperty.call(t,i)&&n.push(e(t[i],i,t));return n},u=function m(t){if(r.isObject(t)){var e={};return s(t,function(t,n){return e[n]=m(t)}),e}return r.isArray(t)?a(t,function(t){return m(t)}):t},l=function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];var r=t;return r&&a(n,function(t){return t&&s(t,function(t,e){return r[e]=t})}),r},c=function(t,e,n){function i(){this.constructor=t}var r=t;
return l(r,e),i.prototype=e.prototype,r.prototype=new i,l(r.prototype,n),r.__super__=e.prototype,r},h={View:{},Region:{},Module:{},Model:{},Store:{},register:function(t,e,n){this[t][e]=n},create:function(t,e){for(var n=this[t][e]||r[t],i=arguments.length,o=Array(i>2?i-2:0),a=2;a<i;a++)o[a-2]=arguments[a];return new(Function.prototype.bind.apply(n,[null].concat(o)))}},d=0,_=null;"undefined"!=typeof window&&(_=window),a(["Function","Array","String","Object"],function(t){var e="[object "+t+"]";r["is"+t]=function(t){
return r.toString.call(t)===e}}),a(["Module","View","Region","Model","Store"],function(t){r["register"+t]=function(e,n){return h.register(t,e,n)},h["create"+t]=function(e){for(var n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return h.create.apply(h,[t,e].concat(i))}}),l(r,{assign:l,uniqueId:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return""+t+ ++d},adapt:function(t){l(r.Adapter,t)},extend:c}),r.Adapter={Promise:Promise,ajax:function(t){var e=new XMLHttpRequest,n="";
t.data&&(n=s(t.data,function(t,e){return e+"="+encodeURIComponent(t)}).join("&")),e.open(t.type,n&&"GET"===t.type?t.url+"?"+n:t.url,!0);var i=new Promise(function(t,n){e.onload=function(){return this.status>=200&&this.status<400?void t(JSON.parse(this.response)):void n(e)},e.onerror=function(){n(e)}});return n&&e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.beforeRequest&&t.beforeRequest(e),e.send(n),i},exportError:function(){},ajaxResult:function(t){return t[0]},getFormData:function(t){
throw new Error("getFormData is not implemented",t)},eventPrevented:function(t){return t.defaultPrevented},addEventListener:function(t,e,n,i){t.addEventListener(e,n,i)},removeEventListener:function(t,e,n){t.removeEventListener(e,n)},hasClass:function(t,e){return t.classList.contains(e)},addClass:function(t,e){t.classList.add(e)},removeClass:function(t,e){t.classList.remove(e)}},r.Promise=function(t){this.context=t},r.assign(r.Promise.prototype,{create:function(t){var e=this;return new r.Adapter.Promise(function(n,i){
t.call(e.context,n,i)})},resolve:function(t){return r.Adapter.Promise.resolve(t)},reject:function(t){return r.Adapter.Promise.reject(t)},parallel:function(t){for(var e=this,n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return this.create(function(n,o){var u=[],l=[],c={};return a(t,function(t,n){var a=void 0;try{a=r.isFunction(t)?t.apply(e.context,i):t}catch(s){return r.Adapter.exportError(s),void o(s)}a&&a.then?(c[l.length]=n,l.push(a)):u[n]=a}),0===l.length?n(u):void r.Adapter.Promise.all(l).then(function(t){
s(c,function(e,n){return u[n]=t[e]}),n(u)},function(t){o(t)})})},chain:function(){for(var e=this,n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];var a=null,s=function u(n,i,o,s){var l=function(t){a=t,0===n.length?o(a):u(n,n.shift(),o,s)};if(r.isArray(i))0===i.length?l([]):e.parallel.apply(e,[i].concat(t(null!=a?[a]:[]))).then(l,s);else{var c=void 0;try{c=r.isFunction(i)?i.apply(e.context,null!=a?[a]:[]):i}catch(h){return r.Adapter.exportError(h),void s(h)}c&&c.then?c.then(l,s):l(c)}};return 0===i.length?this.resolve():this.create(function(t,e){
s(i,i.shift(),t,e)})}}),r.Event={on:function(t,e,n){this._events||(this._events={}),(this._events[t]||(this._events[t]=[])).push({fn:e,ctx:n})},off:function(t,e){if(this._events&&t&&this._events[t]){if(!e)return void delete this._events[t];var n=[];return a(this._events[t],function(t){t.fn!==e&&n.push(t)}),0===n.length?void delete this._events[t]:void(this._events[t]=n)}},trigger:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return t&&this._events&&this._events[t]?void a(this._events[t],function(t){
return t.fn.apply(t.ctx,n)}):this},delegateEvent:function(t){var e=this,n="--"+t.id,i=t;return l(i,{_listeners:{},listenTo:function(t,e,n,r){(i._listeners[e]||(i._listeners[e]=[])).push({fn:n,obj:t}),t.on(e,n,r||i)},stopListening:function(t,e,n){s(i._listeners,function(r,o){var s=[];a(r,function(i){var r=n&&i.fn===n&&e===o&&t===i.obj;return r=r||!n&&e&&e===o&&t===i.obj,r=r||!n&&!e&&t&&t===i.obj,(r=r||!n&&!e&&!t)?void i.obj.off(o,i.fn):void s.push(i)}),i._listeners[o]=s,0===s.length&&delete i._listeners[o];
})},on:function(t,r,o){i.listenTo(e,t+n,r,o)},off:function(t,r){i.stopListening(e,t&&t+n,r)},trigger:function(t){if(!t)return i;for(var r=arguments.length,o=Array(r>1?r-1:0),a=1;a<r;a++)o[a-1]=arguments[a];o.unshift(t+n)&&e.trigger.apply(e,o)}}),this}},r.Request={get:function(t,e){return this._ajax("GET",t,t.getParams(),e)},post:function(t,e){return this._ajax("POST",t,t.data,e)},put:function(t,e){return this._ajax("PUT",t,t.data,e)},del:function(t,e){return this._ajax("DELETE",t,t.data,e)},save:function(t,e){
return t.data&&t.data[t._idKey]?this.put(t,e):this.post(t,e)},_url:function(t){var e=[],n=t.module._option("urlPrefix",t)||"",i=t.app._option("urlRoot",t)||"",r=t.app._option("urlSuffix",t)||"",o=t._url()||"";for(i&&e.push(i),n&&e.push(n),e.push(t.module.name);0===o.indexOf("../");)e.pop(),o=o.slice(3);return o&&e.push(o),t.data&&t.data[t._idKey]&&e.push(t.data[t._idKey]),r&&e.push(e.pop()+r),e.join("/")},_ajax:function(t,e,n,i){var o=l({type:t},i);return o.data=l({},n,o.data),o.url=this._url(e),
e.Promise.create(function(t,n){r.Adapter.ajax(o,e).then(function(){for(var n=arguments.length,i=Array(n),a=0;a<n;a++)i[a]=arguments[a];e.set(r.Adapter.ajaxResult(i),!o.slient),t(i)},function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return n(e)})})}},r.ComponentManager={_handlers:{},_componentCache:{},setDefaultHandler:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};this._defaultHandler={creator:t,destructor:e}},register:function(t,e){
var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};this._handlers[t]={creator:e,destructor:n}},_create:function(t,e){var n=this,i=e.name,o=e.id,a=e.selector,s=e.options;i||t._error("Component name can not be null");var u=this._handlers[i]||this._defaultHandler;u||t._error("No handler for component:",i);var l=a?t.$$(a):t.$(o),c=o?o:r.uniqueId("comp");return t.chain(u.creator(t,l,s,i),function(e){var i=t.id+c,a=n._componentCache[i],l={id:i,handler:u,index:r.uniqueId(i),options:s
};return r.isArray(a)?a.push(l):n._componentCache[i]=a?[a,l]:l,{id:o,component:e,index:l.index}})},_destroy:function(t,e){var n=this,i=t.id+e.id,o=this._componentCache[i],s=o;r.isArray(o)?(this._componentCache[i]=[],a(o,function(t){t.index!==e.index?n._componentCache[i].push(t):s=t}),0===this._componentCache[i].length&&delete this._componentCache[i]):delete this._componentCache[i],s.handler.destructor(t,e.component,s.options)}},r.Base=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];
this.options=e,this.id=r.uniqueId("D"),this.name=t,this.Promise=new r.Promise(this),l(this,n),e.mixin&&this._mixin(e.mixin),this._loadedPromise=this._initialize()},r.assign(r.Base.prototype,{_initialize:function(){},_option:function(t){for(var e=this.options[t],n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return r.isFunction(e)?e.apply(this,i):e},_error:function(t){if(!r.isString(t))throw t;for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];throw new Error("["+(this.module?this.module.name+":":"")+this.name+"] "+t+" "+n.join(" "));
},_mixin:function(t){var e=this;s(t,function(t,n){var i=e[n];return i?void(r.isFunction(i)&&(e[n]=function(){for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];return r.unshift(i),t.apply(e,r)})):void(e[n]=t)})},chain:function(){var t;return(t=this.Promise).chain.apply(t,arguments)}}),r.Renderable=function(t,e,n,i,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};r.Renderable.__super__.constructor.call(this,t,o,{app:e,moduleOptions:a,module:n,components:{},_loader:i,
_componentMap:{},_events:{}}),this._eventHandlers=this._option("handlers"),e.delegateEvent(this)},c(r.Renderable,r.Base,{_initialize:function(){var t=this;return this._templateEngine=this._option("templateEngine")||this.module&&this.module._templateEngine||this.app._templateEngine,this.chain([this._templateEngine._load(this),this._initializeEvents()],function(e){var i=n(e,1),r=i[0];return t._template=r})},render:function(t){return this._render(null==t?this.renderOptions:t,!0)},$:function(t){return this.$$("#"+this._wrapDomId(t))[0];
},$$:function(t){return this._getElement().querySelectorAll(t)},_render:function(t,e){var n=this;return this._region||this._error("Region is null"),this.renderOptions=null==t?this.renderOptions||{}:t,this.chain(this._loadedPromise,this._destroyComponents,function(){return n.trigger("beforeRender")},function(){return n._option("beforeRender")},this._beforeRender,this._serializeData,function(t){return n._renderTemplate(t,e)},this._renderComponents,this._afterRender,function(){return n._option("afterRender");
},function(){return n.trigger("afterRender")},this)},_setRegion:function(t){this._region=t,this._bindEvents()},_close:function(){var t=this;return this._region?this.chain(function(){return t.trigger("beforeClose")},function(){return t._option("beforeClose")},this._beforeClose,[this._unbindEvents,this._destroyComponents,function(){return t._region._empty(t)}],this._afterClose,function(){return t._option("afterClose")},function(){return t.trigger("afterClose")},function(){return delete t._region},this):this.Promise.resolve(this);
},_getElement:function(){return this._region?this._region._getElement(this):null},_serializeData:function(){return{Global:this.app.global,Self:this}},_renderTemplate:function(t,e){this._templateEngine._execute(this,t,this._template,e)},_initializeEvents:function(t){var e=this;s(t||this._option("events"),function(t,n){var i=n.replace(/(^\s+)|(\s+$)/g,"").split(/\s+/),r={key:n};2!==i.length&&e._error("Invalid event key"),r.eventType=i[0],"*"===i[1].slice(-1)?(r.id=e._wrapDomId(i[1].slice(0,-1)),r.haveStar=!0,
r.selector="[id^="+r.id+"]"):(r.id=e._wrapDomId(i[1]),r.selector="#"+r.id),r.handler=e._createEventHandler(t,r),e._events[n]=r})},_getEventTarget:function(t,e){for(var n=this._getElement(),i=t;i!==n;){var r=i.getAttribute("id");if(r&&r.slice(0,e.length)===e)return i;i=i.parentNode}},_createEventHandler:function(t,e){var n=this,i=e.haveStar,o=e.id,a=this.app.options.disabledClass;return function(){for(var e=arguments.length,s=Array(e),u=0;u<e;u++)s[u]=arguments[u];n._eventHandlers[t]||n._error("No event handler for name:",t);
var l=s[0],c=n._getEventTarget(l.target,o);r.Adapter.hasClass(c,a)||(i&&s.unshift(c.getAttribute("id").slice(o.length)),n._eventHandlers[t].apply(n,s))}},_bindEvents:function(){var t=this;s(this._events,function(e){t._region._delegateDomEvent(t,e.eventType,e.selector,e.handler)})},_unbindEvents:function(){this._region._undelegateDomEvents(this)},_renderComponents:function(){var t=this;return this.chain(a(this._option("components"),function(e){var n=r.isFunction(e)?e.call(t):e;return n?r.ComponentManager._create(t,n):null;
}),function(e){return a(e,function(e){if(e){var n=e.id,i=e.component,r=e.index;t.components[n]=i,t._componentMap[r]=e}})})},_destroyComponents:function(){var t=this;this.components={},s(this._componentMap,function(e){return r.ComponentManager._destroy(t,e)}),this._componentMap={}},_wrapDomId:function(t){return this.id+t},_beforeRender:function(){},_afterRender:function(){},_beforeClose:function(){},_afterClose:function(){}}),r.RenderableContainer=function(){r.RenderableContainer.__super__.constructor.apply(this,arguments);
},c(r.RenderableContainer,r.Renderable,{_initialize:function(){var t=r.RenderableContainer.__super__._initialize.call(this);return this.items={},this.chain(t,this._initializeItems)},_afterRender:function(){return this.chain(this._initializeRegions,this._renderItems)},_afterClose:function(){return this._closeRegions()},_initializeItems:function(){var t=this;this.chain(s(this._option("items"),function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1],i=r.isFunction(e)?e.call(t):e;
return r.isString(i)&&(i={region:i}),t.app[e.isModule?"_createModule":"_createView"](n,t,i).then(function(e){return t.items[n]=e,e})}))},_initializeRegions:function(){var t=this;return this.regions={},this.chain(this._closeRegions,function(){a(t.$$("[data-region]"),function(e){var n=t._createRegion(e);t.regions[n.name]=n})})},_renderItems:function(){var t=this;return this.chain(s(this.items,function(e){var n=e.moduleOptions.region;return n?(t.regions[n]||t._error("Region: "+n+" is not defined"),t.regions[n].show(e)):null;
}),this)},_createRegion:function(t){var e=t.getAttribute("data-region");return this.app._createRegion(t,e,this)},_closeRegions:function(){var t=this.regions;return t?(this.regions={},this.chain(s(t,function(t){return t.close()}),this)):this}}),r.ActionCreator=function(){r.ActionCreator.__super__.constructor.apply(this,arguments)},r.extend(r.ActionCreator,r.Renderable,{_initializeEvents:function(){var t=r.ActionCreator.__super__._initializeEvents;t.call(this),t.call(this,this._option("actions"))},
_createEventHandler:function(t,e){var n=r.ActionCreator.__super__._createEventHandler,i=!!(this._option("actions")||{})[e.key];return i?this._createAction(t,e):n.call(this,t,e)},_createAction:function(t,e){var n=this,i=e.id,o=this.app.options.disabledClass,a=this._option("dataForActions")||{},s=a[t],u=this._option("actionCallbacks")||{},l=u[t];return function(e){var a=n._getEventTarget(e.target,i);if(!r.Adapter.hasClass(a,o)){r.Adapter.addClass(a,o);var u=n._getActionPayload(a);n.chain(r.isFunction(s)?s.call(n,u,e):u,function(e){
return e!==!1&&n.module.dispatch(t,e)},function(t){return t!==!1&&(l&&l.call(n,t))}).then(function(){return r.Adapter.removeClass(a,o)},function(){return r.Adapter.removeClass(a,o)})}}},_getActionPayload:function(t){for(var e=this._getElement(),n=t,i=!1;n&&n!==e&&"FORM"!==n.tagName;)n=n.parentNode;n||(n=e);var o="FORM"===n.tagName?r.Adapter.getFormData(n):{};return a(n.querySelectorAll("[data-name][data-value]"),function(e){if(e===t)return i=t.getAttribute("data-name"),void(o[i]=t.getAttribute("data-value"));
var n=e.getAttribute("data-name");if(!i||i!==n){var a=e.getAttribute("data-value"),s=o[n];r.isArray(s)?s.push(a):o[n]=null==s?a:[s,a]}}),o}}),r.View=function(){r.View.__super__.constructor.apply(this,arguments)},c(r.View,r.ActionCreator,{_initialize:function(){return this.bindings={},this.chain(r.View.__super__._initialize.call(this),this._initializeDataBinding)},_initializeDataBinding:function(){var t=this;this._dataBinding={},s(this._option("bindings"),function(e,n){var i=t.bindings[n]=t.module.store.models[n];
i||t._error("No model:",n),e&&(t._dataBinding[n]={model:i,value:e,fn:function(){e===!0&&t._region&&t.render(t.renderOptions),r.isString(e)&&t._option(e)}})})},_bindData:function(){var t=this;s(this._dataBinding,function(e){return t.listenTo(e.model,"changed",e.fn)})},_unbindData:function(){this.stopListening()},_setRegion:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];r.View.__super__._setRegion.apply(this,e),this._bindData()},_close:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];
return this.chain(r.View.__super__._close.apply(this,e),this._unbindData,this)},_serializeData:function(){var t=this,e=r.View.__super__._serializeData.call(this);return s(this.bindings,function(t,n){return e[n]=t.get(!0)}),s(this._option("dataForTemplate"),function(n,i){return e[i]=n.call(t,e)}),e}}),r.Module=function(){r.Module.__super__.constructor.apply(this,arguments)},r.extend(r.Module,r.RenderableContainer,{_initialize:function(){return this._initializeStore(),r.Module.__super__._initialize.call(this);
},dispatch:function(t,e){return this.store.dispatch(t,e)},_initializeStore:function(){this.store=this.app._createStore(this,this._option("store"))},_afterClose:function(){return delete this.app._modules[this.name+"--"+this.id],this.store._destory(),r.Module.__super__._afterClose.call(this)},_beforeRender:function(){var t=this;return this.app._modules[this.name+"--"+this.id]=this,this.chain(r.Module.__super__._beforeRender.call(this),function(){return t.store._loadEagerModels()})},_afterRender:function(){
var t=this;return this.chain(r.Module.__super__._afterRender.call(this),function(){return t.store._loadLazyModels()})}});var p=["blur","focus","scroll","resize"];r.Region=function(t,e,n,i){r.Region.__super__.constructor.call(this,i||"Region",{},{app:t,module:e,_el:n,_delegated:{}}),this._el||this._error("The DOM element for region is required"),t.delegateEvent(this)},c(r.Region,r.Base,{show:function(t,e){var i=this;return this._isCurrent(t)?e&&e.forceRender===!1?this.Promise.resolve(this._current):this._current._render(e,!0):this.chain(r.isString(t)?this.app._createModule(t):t,function(t){
return t instanceof r.Renderable||i._error("The item is expected to be an instance of Renderable"),t},[function(t){return i.chain(t._region&&t._region.close(),t)},function(){return i._current&&i.close()}],function(t){var e=n(t,1),r=e[0];i._current=r;var o=r.module?r.module.name+":"+r.name:r.name;return i._getElement().setAttribute("data-current",o),r._setRegion(i),r},function(t){return t._render(e,!1)})},close:function(){var t=this;return this.chain(this._current&&this._current._close(),function(){
return delete t._current},this)},$$:function(t){return this._getElement().querySelectorAll(t)},_isCurrent:function(t){return!!this._current&&(this._current.name===t||!(!t||t.id!==this._current.id))},_getElement:function(){return this._el},_empty:function(){this._getElement().innerHTML=""},_createDelegateListener:function(t){var e=this;return function(){for(var n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];if(e._delegated[t]){var s=i[0],u=s.target;a(e._delegated[t].items,function(t){
if(!r.Adapter.eventPrevented(s)){for(var n=e._getElement().querySelectorAll(t.selector),o=!1,a=0;a<n.length;a++){var l=n[a];if(l===u||l.contains(u)){o=l;break}}o&&t.fn.apply(t.renderable,i.concat([o]))}})}}},_delegateDomEvent:function(t,e,n,i){var o=this._delegated[e];o||(o=this._delegated[e]={listener:this._createDelegateListener(e),items:[]},r.Adapter.addEventListener(this._getElement(),e,o.listener,p.indexOf(e)!==-1)),o.items.push({selector:n,fn:i,renderable:t})},_undelegateDomEvents:function(t){
var e=this;s(this._delegated,function(n,i){var o=[],s=n;a(s.items,function(e){e.renderable!==t&&o.push(e)}),s.items=o,0===o.length&&(delete e._delegated[i],r.Adapter.removeEventListener(e._getElement(),i,s.listener))})}}),r.TemplateEngine=function(t){r.TemplateEngine.__super__.constructor.call(this,"Template Engine",t,{_templateCache:{}})},c(r.TemplateEngine,r.Base,{executeIdReplacement:function(t,e){var n=this,i={};a(t.querySelectorAll("[id]"),function(t){var r=t.getAttribute("id");i[r]&&n._error("Dom ID: "+r+" is already used"),
i[r]=!0,t.setAttribute("id",e._wrapDomId(r))});var r=this._option("attributesReferToId")||["for","data-target","data-parent"];a(r,function(n){return a(t.querySelectorAll("["+n+"]"),function(t){var i=t.getAttribute(n),r="#"===i.charAt(0),o=r?"#"+e._wrapDomId(i.slice(1)):e._wrapDomId(i);t.setAttribute(n,o)})})},_load:function(t){var e=t.id;return this._templateCache[e]?this._templateCache[e]:this._templateCache[e]=this._loadIt(t)},_loadIt:function(t){return t instanceof i.Module?t._loader.loadModuleResource(t,"templates"):function(){
return t.module._template}},_execute:function(t,e,n){var i=t._getElement();i.innerHTML=n(e),this.executeIdReplacement(i,t)}}),r.Store=function(t,e){var n=this;r.Store.__super__.constructor.call(this,"Store",e,{app:t.app,module:t,models:{}}),this.app.delegateEvent(this),this._callbacks=this._option("callbacks"),s(this._callbacks,function(t,e){if("app."===e.slice(0,4))return void n.listenTo(n.app,e,function(e){return t.call(n._callbackContext,e)});if("shared."===e.slice(0,7)){var i=e.slice(7),r=n.models[i];
r&&r.store!==n||n._error("Can not bind to model: "+e),n.listenTo(r,"changed",function(){return t.call(n._callbackContext)})}})},c(r.Store,r.Base,{dispatch:function(t,e){var n=void 0,i=t,o=e;return r.isObject(i)&&(o=i.payload,i=i.name),n=this._callbacks[i],n||this._error("No action callback for name: "+t),this.chain(n.call(this._callbackContext,o))},_initialize:function(){this._initializeModels(),this._callbackContext=l({app:this.app,models:this.models,module:this.module,chain:this.chain},r.Request),
this._callbackContext.Promise=new r.Promise(this._callbackContext)},_initializeModels:function(){var t=this;s(this._option("models"),function(e,n){var i=(r.isFunction(e)?e.call(t):e)||{};if(i.shared===!0)return t.app.viewport?void(t.models[n]=t.app.viewport.store.models[n]):(t.module.name===t.app._option("viewport")&&t._error("Can not define shared model in viewport"),void(t.module.module&&t.module.module.name===t.app._option("viewport")&&(t.models[n]=t.module.module.store.models[n])));if(i.replaceable===!0){
var o=t.module.moduleOptions.models||{};if(o[n]&&t.module.module&&t.module.module.store.models[o[n]])return void(t.models[n]=t.module.module.store.models[o[n]])}t.models[n]=t.app._createModel(t,i,n)})},_loadEagerModels:function(){var t=this;return this.chain(s(this.models,function(e){return e.store!==t?null:e.options.autoLoad===!0?r.Request.get(e):null}))},_loadLazyModels:function(){var t=this;return this.chain(s(this.models,function(e){if(e.store!==t)return null;var n=e.options.autoLoad;return n&&n!==!0?r.Request.get(e):null;
}))},_destory:function(){this.stopListening()}}),r.Model=function(t,e,n){r.Model.__super__.constructor.call(this,n||"Model",e,{app:t.module.app,module:t.module,store:t}),this.data=u(this._option("data"))||{},this._idKey=this._option("idKey")||this.app.options.idKey,this.params=l({},this._option("params")),this.app.delegateEvent(this)},r.extend(r.Model,r.Base,{getFullUrl:function(){return r.Request._url(this)},set:function(t,e){var n=this.options.parse?this._option("parse",t):t;this.data=this.options.root?n[this.options.root]:n,
e&&this.changed()},getParams:function(){return this.params},get:function(t){return t?u(this.data):this.data},clear:function(t){this.data=r.isArray(this.data)?[]:{},t&&this.changed()},changed:function(){this.trigger("changed")},_url:function(){return this._option("url")||""}}),r.Loader=function(t,e){r.Loader.__super__.constructor.call(this,"Loader",e,{app:t})},r.assign(r.Loader,{_analyse:function(t){if(!r.isString(t))return{loader:null,name:t};var e=t.split(":"),n=e.length>1?e.shift():null;return{
loader:n,name:e.shift(),args:e}}}),r.extend(r.Loader,r.Base,{loadResource:function(t){var e=this,n=this.app.options,i=n.scriptRoot,r=n.getResource,o=n.amd,a=i+"/"+t;return this.Promise.create(function(t,n){o?require([a],t,n):t(r?r.call(e.app,a):require("./"+a))})},loadModuleResource:function(t,e){return this.loadResource(t.name+"/"+e)},loadModule:function(t){return this.loadResource(t+"/index")},loadView:function(t,e){return this.loadModuleResource(e,"view-"+t)},loadRouter:function(t){var e="router";
return this.loadResource(t?t+"/"+e:e)}}),r.Application=function(t){r.Application.__super__.constructor.call(this,t&&t.name||"Application",l({scriptRoot:"app",urlRoot:"",urlSuffix:"",caseSensitiveHash:!1,container:_&&_.document.body,disabledClass:"disabled",getResource:null,idKey:"id",viewport:"viewport"},t),{global:{},_modules:{},_loaders:{}})},r.extend(r.Application,r.Base,{_initialize:function(){this._templateEngine=this._option("templateEngine")||new r.TemplateEngine,this.registerLoader("default",new r.Loader(this),!0),
this._region=this._createRegion(this._option("container"),"Region")},registerLoader:function(t,e,n){return this._loaders[t]=e,n&&(this._defaultLoader=e),this},start:function(e){var n,i=this;return e&&(this._router=new r.Router(this)),this.chain(!!e&&(n=this._router)._mountRoutes.apply(n,t(this._option("routers"))),this._region.show(this._option("viewport")),function(t){return i.viewport=t},function(){return e&&i._router._start(e)},this)},stop:function(){this.off(),this._region.close(),this._router&&this._router._stop();
},navigate:function(t,e){this._router&&this._router.navigate(t,e)},dispatch:function(t,e){var n=r.isObject(t)?t.name:t,i=r.isObject(t)?t.payload:e;this.trigger("app."+n,i)},show:function(t,e,n){return this.viewport.regions[t].show(e,n)},_getLoader:function(t,e){return t&&this._loaders[t]||e&&e._loader||this._defaultLoader},_createModule:function(t,e,n){var i=this,o=r.Loader._analyse(t),a=o.name,s=o.loader,u=this._getLoader(s,parent);return this.chain(u.loadModule(a),function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};
return h.createModule(t.type,a,i,e,u,t,n)})},_createView:function(t,e,n){var i=this,o=r.Loader._analyse(t),a=o.name,s=o.loader,u=this._getLoader(s,e);return this.chain(u.loadView(a,e),function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return h.createView(t.type,a,i,e,u,t,n)})},_createRegion:function(t,e,n){var i=r.Loader._analyse(e),o=i.name,a=i.loader;return h.createRegion(a,this,n,t,o)},_createStore:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};
return h.createStore(e.type,t,e)},_createModel:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];return h.createModel(e.type,t,e,n)}}),l(r.Application.prototype,r.Event);var f=_&&_.history&&"pushState"in _.history,g=[/:([\w\d]+)/g,"([^/]+)",/\*([\w\d]+)/g,"(.*)"];l(e.prototype,{match:function(t){return this.pattern.lastIndex=0,this.pattern.test(t)},handle:function(e){var n,i=this;this.pattern.lastIndex=0;var r=this.pattern.exec(e).slice(1),o=this.router._getInterceptors(this.path);
return o.push(this.fn),(n=this.router).chain.apply(n,t(a(o,function(t,e){return function(n){return t.apply(i.router,e>0?[n].concat(r):r)}})))}}),r.Router=function(t){var e=this;r.Router.__super__.constructor.call(this,"Router",{},{app:t,_routes:[],_interceptors:{},_started:!1}),this._prefix=t._option("routerPrefix")||"#!/",this._EVENT_HANDLER=function(){return e._dispath(e._getHash())}},c(r.Router,r.Base,{navigate:function(t,e){this._started&&(f?_.history.pushState({},_.document.title,this._prefix+t):_.location.replace(this._prefix+t),
e!==!1&&this._dispath(t))},_start:function(t){if(!this._started&&_){r.Adapter.addEventListener(_,"hashchange",this._EVENT_HANDLER,!1);var e=this._getHash()||t;this._started=!0,e&&this.navigate(e)}},_stop:function(){this._started&&(r.Adapter.removeEventListener(_,"hashchange",this._EVENT_HANDLER),this._started=!1)},_dispath:function(t){if(t&&t!==this._previousHash){this._previousHash=t;for(var e=0;e<this._routes.length;e++){var n=this._routes[e];if(n.match(t))return void n.handle(t)}}},_mountRoutes:function(){
var t=this,e=o.call(arguments);return this.chain(a(e,function(e){return t.app._getLoader(e).loadRouter(e)}),function(n){return a(n,function(n,i){return t._addRoute(e[i],n)})})},_addRoute:function(t,n){var i=this,o=n.routes,a=n.interceptors;s(r.isFunction(o)?o.apply(this):o,function(r,o){var a=(t+"/"+o).replace(/^\/|\/$/g,"");i._routes.unshift(new e(i.app,i,a,n[r]))}),s(r.isFunction(a)?a.apply(this):a,function(e,r){var o=(t+"/"+r).replace(/^\/|\/$/g,"");i._interceptors[o]=n[e]})},_getInterceptors:function(t){
var e=[],n=t.split("/");for(n.pop();n.length>0;){var i=n.join("/");this._interceptors[i]&&e.unshift(this._interceptors[i]),n.pop()}return this._interceptors[""]&&e.unshift(this._interceptors[""]),e},_getHash:function(){var t=_.location.hash;return t.slice(0,this._prefix.length)!==this._prefix?"":t.slice(this._prefix.length)}});var v={pageSize:10,pageKey:"_page",pageSizeKey:"pageSize",recordCountKey:"recordCount",params:function(t){return t}};return r.PageableModel=function(t,e){r.PageableModel.__super__.constructor.call(this,t,e),
this.data=this._option("data")||[],this._p={page:this._option("page")||1,pageCount:0,pageSize:this._option("pageSize")||v.pageSize,pageKey:this._option("pageKey")||v.pageKey,pageSizeKey:this._option("pageSizeKey")||v.pageSizeKey,recordCountKey:this._option("recordCountKey")||v.recordCountKey}},l(r.PageableModel,{setDefault:function(t){l(v,t)}}),c(r.PageableModel,r.Model,{set:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];this._p.recordCount=t[this._p.recordCountKey]||0,
this._p.pageCount=Math.ceil(this._p.recordCount/this._p.pageSize),r.PageableModel.__super__.set.call(this,t,e)},getParams:function(){var t=this._p,e=t.page,n=t.pageKey,i=t.pageSizeKey,r=t.pageSize,o=this.params;return o[n]=e,o[i]=r,v.params(o)},clear:function(t){this._p.page=1,this._p.recordCount=0,this._p.pageCount=0,r.PageableModel.__super__.clear.call(this,t)},turnToPage:function(t){return t<=this._p.pageCount&&t>=1&&(this._p.page=t),this},firstPage:function(){return this.turnToPage(1)},lastPage:function(){
return this.turnToPage(this._p.pageCount)},nextPage:function(){return this.turnToPage(this._p.page+1)},prevPage:function(){return this.turnToPage(this._p.page-1)},getPageInfo:function(){var t=this._p,e=t.page,n=t.pageSize,i=t.recordCount,r=t.pageCount,o=void 0;return o=this.data&&this.data.length>0?{page:e,start:(e-1)*n+1,end:e*n,total:i,pageCount:r}:{page:e,start:0,end:0,total:0,pageCount:r},o.end>o.total&&(o.end=o.total),o}}),r.registerModel("pageable",r.PageableModel),r.MultiRegion=function(){
r.MultiRegion.__super__.constructor.apply(this,arguments)},r.extend(r.MultiRegion,r.Region,{_initialize:function(){this._items={},this._elements={}},activate:function(){},show:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.moduleOptions,a=r.isString(t),s=i.key;a||t instanceof r.Renderable||this._error("The item is expected to be an instance of Renderable"),!s&&o&&o.key&&(s=o.key),s||this._error("Region key is required");var u=this._items[s];return this._isCurrent(s,u,t)?i.forceRender===!1?this.Promise.resolve(u):u.render(i):this.chain(a?this.app._createModule(t):t,[function(t){
return e.chain(t._region&&t._region.close(),t)},function(){return e.chain(u&&u._close(),function(){delete e._items[s],delete e._elements[s]})}],function(t){var r=n(t,1),o=r[0],a=o.module?o.module.name+":"+o.name:o.name,u=e._getElement(o,s);return e._items[s]=o,u.setAttribute("data-current",a),o._setRegion(e),o._render(i,!1)})},_createElement:function(){var t=_.document.createElement("div");return this._el.appendChild(t),t},_getElement:function(t,e){if(!t)return this._el;var n=e||t.renderOptions.key||t.moduleOptions.key;
return this._elements[n]||(this._elements[n]=this._createElement(n,t)),this._elements[n]},_isCurrent:function(t,e,n){return!!e&&(e.name===n||n&&n.id===e.id)},_empty:function(t){if(!t)return void r.MultiRegion.__super__._empty.call(this);var e=this._getElement(t);e.parentNode.removeChild(e)},close:function(){var t=this;return this.chain(s(this._items,function(t){return t._close()}),function(){t._elements={},t._items={},delete t._current},this)}}),i});
//# sourceMappingURL=drizzle.min.js.map
